<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Camper Remote Pro</title>
    <style>
        :root { --blue: #00d2ff; --green: #39ff14; --red: #ff3131; --bg: #0a0a0a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; -webkit-user-select: none; }
        .status { width: 100%; background: #111; padding: 12px; font-size: 0.8em; text-align: center; border-bottom: 1px solid #222; color: #888; letter-spacing: 1px; }
        #bubble-container { width: 240px; height: 240px; border: 4px solid #333; border-radius: 50%; margin: 25px auto; position: relative; background: radial-gradient(circle, #1a1a1a, #000); box-shadow: inset 0 0 30px #000; }
        #bubble { width: 40px; height: 40px; background: var(--green); border-radius: 50%; position: absolute; top: 100px; left: 100px; transition: 0.1s ease-out; box-shadow: 0 0 20px var(--green); opacity: 0.9; }
        .data { font-size: 1.8em; margin-bottom: 25px; color: var(--blue); font-family: monospace; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 92%; max-width: 420px; padding-bottom: 40px; }
        .btn { background: #1a1a1a; border: 1px solid #333; color: #eee; padding: 20px; border-radius: 12px; font-weight: bold; font-size: 0.9em; touch-action: manipulation; }
        .btn:active { background: #333; transform: scale(0.96); border-color: var(--blue); box-shadow: 0 0 15px var(--blue); }
        .btn-main { background: #003344; border-color: var(--blue); color: var(--blue); grid-column: span 2; }
        .btn-danger { border-color: var(--red); color: var(--red); grid-column: span 2; margin-top: 10px; }
        .btn-calib { border-color: orange; color: orange; grid-column: span 2; font-size: 0.7em; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="status" id="stat">BLUETOOTH BEREIT</div>
    <button class="btn btn-main" style="margin: 15px; width: 92%;" onclick="connect()">VERBINDUNG STARTEN</button>
    
    <div id="bubble-container"><div id="bubble"></div></div>
    
    <div class="data">S: <span id="p_val">0.0</span>° | F: <span id="r_val">0.0</span>°</div>
    
<div class="grid">
    <button class="btn" onpointerdown="send('M0_UP')" onpointerup="send('STOP')">V-L ▲</button>
    <button class="btn" onpointerdown="send('M0_DN')" onpointerup="send('STOP')">V-L ▼</button>
    
    <button class="btn" onpointerdown="send('M1_UP')" onpointerup="send('STOP')">V-R ▲</button>
    <button class="btn" onpointerdown="send('M1_DN')" onpointerup="send('STOP')">V-R ▼</button>
    
    <button class="btn" onpointerdown="send('M2_UP')" onpointerup="send('STOP')">H-L ▲</button>
    <button class="btn" onpointerdown="send('M2_DN')" onpointerup="send('STOP')">H-L ▼</button>
    
    <button class="btn" onpointerdown="send('M3_UP')" onpointerup="send('STOP')">H-R ▲</button>
    <button class="btn" onpointerdown="send('M3_DN')" onpointerup="send('STOP')">H-R ▼</button>
    
    <button class="btn btn-main" onclick="send('AUTO')">AUTO LEVEL</button>
    <button class="btn" style="background:#400; grid-column: span 2;" onclick="send('RETRACT')">ALLE EINFAHREN</button>
    <button class="btn" style="border-color:orange; color:orange; grid-column: span 2;" onclick="if(confirm('Nullpunkt setzen?')) send('CALIB')">NULLPUNKT SPEICHERN</button>
</div>

    <script>
        // MUSS EXAKT MIT DEM ESP32 CODE ÜBEREINSTIMMEN
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_DATA_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const CHAR_CTRL_UUID = "d2748e61-9c16-419b-a01c-6d9b4b4458f4";

        let charData, charCtrl;

        async function connect() {
            try {
                document.getElementById('stat').innerText = "SUCHE GERÄT...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Camper' }],
                    optionalServices: [SERVICE_UUID]
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                charData = await service.getCharacteristic(CHAR_DATA_UUID);
                charCtrl = await service.getCharacteristic(CHAR_CTRL_UUID);
                
                document.getElementById('stat').innerText = "VERBUNDEN: " + device.name;
                document.getElementById('stat').style.color = "var(--green)";

                charData.startNotifications();
                charData.addEventListener('characteristicvaluechanged', (e) => {
                    let val = new TextDecoder().decode(e.target.value);
                    let parts = val.split(';');
                    let p = parseFloat(parts[0].split(':')[1]);
                    let r = parseFloat(parts[1].split(':')[1]);
                    
                    document.getElementById('p_val').innerText = p.toFixed(1);
                    document.getElementById('r_val').innerText = r.toFixed(1);
                    
                    // Skalierung der Libelle: 100px ist Center, 15px pro Grad Auslenkung
                    document.getElementById('bubble').style.left = (100 + (p * 15)) + "px";
                    document.getElementById('bubble').style.top = (100 + (r * 15)) + "px";
                });
            } catch (err) { 
                document.getElementById('stat').innerText = "FEHLER: " + err;
                console.error(err);
            }
        }
async function send(msg) {
    if (!charCtrl) {
        console.log("KONTROLL-CHAR NICHT GEFUNDEN");
        return;
    }
    
    const encoder = new TextEncoder();
    const data = encoder.encode(msg);

    try {
        // Wir versuchen beide Arten kurz hintereinander, falls eine blockiert wird
        console.log("Sende: " + msg);
        await charCtrl.writeValueWithResponse(data);
    } catch (e) {
        console.log("Versuche alternative Sendemethode...");
        try {
            await charCtrl.writeValueWithoutResponse(data);
        } catch (e2) {
            console.error("Beide Sendemethoden gescheitert:", e2);
        }
    }
}
    </script>
</body>

</html>



